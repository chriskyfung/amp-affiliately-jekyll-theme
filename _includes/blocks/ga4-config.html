{% comment %}
  File: ga4-config.html
  Description: This file contains AMP analytics configuration for tracking user interactions
               with YouTube videos and outbound link clicks using Google Analytics 4 (GA4).
               It includes event triggers for video play, pause, progress, and completion,
               as well as tracking for anchor clicks leading to external sites.
  Author: Chris K.Y. FUNG (https://chriskyfung.github.io/)
  Date: 2024-11-18
  Notes:
    - Verify that the 'site.ga4' variable is properly configured in your _config.yml file 
      to activate [Google Analytics](https://analytics.google.com/) tracking.
    - The 'include.yt_selectors' serve as placeholders for CSS selectors targeting
      <amp-youtube> tags and should be provided by site_content_postproc.html.
{% endcomment %}

{%- if site.ga4 -%}
<amp-analytics type="gtag" data-credentials="include">
  <script type="application/json">
  {
    "vars": {
      "gtag_id": "{{ site.ga4 }}",
      "config": {
        "{{ site.ga4 }}": { "groups": "default" }
      }
    },
    "triggers": {
      "trackAnchorClicks": {
        "on": "click",
        "selector": "a:not([href^='{{ site.url }}'])",
        "vars": {
          "event_name": "outgoing_click",
          "method": "Google",
          "link_url": "${eventLabel}",
          "outbound": true
        }{%- if page.amp.youtube %}
      },
      "videoPlay": {
        "on": "video-play",
        "request": "event",
        "selector": [{{ include.yt_selectors }}],
        "vars": {
          "event_name": "video_start",
          "method": "Google",
          "video_current_time": "${currentTime}",
          "video_duration": "${duration}",
          "video_percent": "$CALC($CALC(${currentTime}, ${duration}, divide, false), 100, multiply, true)",
          "video_provider": "youtube",
          "video_title": "${videoTitle}",
          "video_url": "${videoUrl}"
        }
      },
      "videoPause": {
        "on": "video-pause",
        "request": "event",
        "selector": [{{ include.yt_selectors }}],
        "vars": {
          "event_name": "video_paused",
          "method": "Google",
          "video_current_time": "${currentTime}",
          "video_duration": "${duration}",
          "video_percent": "$CALC($CALC(${currentTime}, ${duration}, divide, false), 100, multiply, true)",
          "video_provider": "youtube",
          "video_title": "${videoTitle}",
          "video_url": "${videoUrl}"
        }
      },
      "VideoPercentagePlayed": {
        "on": "video-percentage-played",
        "request": "event",
        "selector": [{{ include.yt_selectors }}],
        "vars": {
          "event_name": "video_progress",
          "method": "Google",
          "video_current_time": "${currentTime}",
          "video_duration": "${duration}",
          "video_percent": "$CALC($CALC(${currentTime}, ${duration}, divide, false), 100, multiply, true)",
          "video_provider": "youtube",
          "video_title": "${videoTitle}",
          "video_url": "${videoUrl}"
        },
        "videoSpec": {
          "percentages": [10, 25, 50, 75]
        }
      },
      "videoEnded": {
        "on": "video-ended",
        "request": "event",
        "selector": [{{ include.yt_selectors }}],
        "vars": {
          "event_name": "video_complete",
          "method": "Google",
          "video_current_time": "${currentTime}",
          "video_duration": "${duration}",
          "video_percent": "$CALC($CALC(${currentTime}, ${duration}, divide, false), 100, multiply, true)",
          "video_provider": "youtube",
          "video_title": "${videoTitle}",
          "video_url": "${videoUrl}"
        }{% endif %}
      }
    }
  }
  </script>
</amp-analytics>
{%- endif -%}
